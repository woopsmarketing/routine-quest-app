# ğŸ ë°±ì—”ë“œ API Docker ì´ë¯¸ì§€
# FastAPI ê¸°ë°˜ ë£¨í‹´ í€˜ìŠ¤íŠ¸ ë©”ì¸ API ì„œë²„

FROM python:3.11-slim

# ğŸ·ï¸ ë©”íƒ€ë°ì´í„°
LABEL maintainer="Routine Quest Team"
LABEL description="FastAPI backend for Routine Quest app"

# ğŸ“ ì‘ì—… ë””ë ‰í† ë¦¬ ì„¤ì •
WORKDIR /app

# ğŸ”§ ì‹œìŠ¤í…œ íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸ ë° í•„ìˆ˜ íŒ¨í‚¤ì§€ ì„¤ì¹˜
RUN apt-get update && apt-get install -y \
    gcc \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜ (ë ˆì´ì–´ ìºì‹± ìµœì í™”)
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# ğŸ“‹ ì• í”Œë¦¬ì¼€ì´ì…˜ ì½”ë“œ ë³µì‚¬
COPY . .

# ğŸ‘¤ ë¹„ë£¨íŠ¸ ì‚¬ìš©ì ìƒì„± (ë³´ì•ˆ)
RUN useradd --create-home --shell /bin/bash app \
    && chown -R app:app /app
USER app

# ğŸŒ í¬íŠ¸ ë…¸ì¶œ
EXPOSE 8000

# ğŸ¥ í—¬ìŠ¤ì²´í¬
HEALTHCHECK --interval=30s --timeout=30s --start-period=5s --retries=3 \
    CMD curl -f http://localhost:8000/health || exit 1

# ğŸš€ ì‹¤í–‰ ëª…ë ¹
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]