#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# ğŸ” Pre-commit ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
echo "ğŸ” Pre-commit ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤..."

# Lint-stagedë¥¼ í†µí•œ ìŠ¤í…Œì´ì§•ëœ íŒŒì¼ë§Œ ê²€ì‚¬
pnpm lint-staged

# Python ê°€ìƒí™˜ê²½ í™œì„±í™” í›„ ë°±ì—”ë“œ ë¦°íŠ¸ ê²€ì‚¬
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
    source venv/Scripts/activate
else
    source venv/bin/activate
fi

# ìŠ¤í…Œì´ì§•ëœ Python íŒŒì¼ì´ ìˆëŠ”ì§€ í™•ì¸
STAGED_PYTHON=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(py)$' || true)

if [ -n "$STAGED_PYTHON" ]; then
    echo "ğŸ Python íŒŒì¼ í’ˆì§ˆ ê²€ì‚¬ ì¤‘..."
    
    # Black í¬ë§·íŒ… ê²€ì‚¬
    echo "ğŸ“ Black í¬ë§·íŒ… ê²€ì‚¬..."
    black --check $STAGED_PYTHON
    
    # Ruff ë¦°íŠ¸ ê²€ì‚¬
    echo "ğŸ” Ruff ë¦°íŠ¸ ê²€ì‚¬..."
    ruff check $STAGED_PYTHON
    
    # MyPy íƒ€ì… ê²€ì‚¬ (apiì™€ ai ë””ë ‰í† ë¦¬ì—ì„œë§Œ)
    for file in $STAGED_PYTHON; do
        if [[ $file == api/* ]] || [[ $file == ai/* ]]; then
            echo "ğŸ” MyPy íƒ€ì… ê²€ì‚¬: $file"
            mypy $file
        fi
    done
fi

# Flutter íŒŒì¼ì´ ë³€ê²½ëœ ê²½ìš° dart analyze ì‹¤í–‰
STAGED_DART=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(dart)$' || true)

if [ -n "$STAGED_DART" ]; then
    echo "ğŸ“± Flutter íŒŒì¼ ê²€ì‚¬ ì¤‘..."
    cd client
    
    # Dart í¬ë§·íŒ… ê²€ì‚¬
    echo "ğŸ“ Dart í¬ë§·íŒ… ê²€ì‚¬..."
    dart format --set-exit-if-changed $STAGED_DART
    
    # Dart ë¶„ì„
    echo "ğŸ” Dart ë¶„ì„..."
    flutter analyze --no-fatal-infos
    
    cd ..
fi

echo "âœ… Pre-commit ê²€ì‚¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"