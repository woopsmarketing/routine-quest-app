name: ğŸµ Vibecoding Workflow (Feature-Complete)

on:
  push:
    branches:
      - 'feature/cursor-**'
      - 'feature/claude-**'
      - 'feature/collab-**'
  pull_request:
    branches: [develop, main]
  workflow_dispatch:
    inputs:
      session_type:
        description: 'ë°”ì´ë¸Œì½”ë”© ì„¸ì…˜ íƒ€ì…'
        required: true
        default: 'feature-complete'
        type: choice
        options:
          - feature-complete
          - cursor-only
          - claude-only
          - collaborative
      feature_status:
        description: 'ê¸°ëŠ¥ ê°œë°œ ìƒíƒœ'
        required: false
        default: 'in-progress'
        type: choice
        options:
          - in-progress
          - ready-for-review
          - feature-complete

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.16.0'

jobs:
  # ===================================
  # ğŸ¯ ë°”ì´ë¸Œì½”ë”© ì„¸ì…˜ ê°ì§€
  # ===================================
  detect-session:
    name: ğŸ¯ Detect Vibecoding Session
    runs-on: ubuntu-latest
    outputs:
      session_type: ${{ steps.detect.outputs.session_type }}
      cursor_changes: ${{ steps.detect.outputs.cursor_changes }}
      claude_changes: ${{ steps.detect.outputs.claude_changes }}
      sync_required: ${{ steps.detect.outputs.sync_required }}
      feature_complete: ${{ steps.detect.outputs.feature_complete }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Detect session type and changes
        id: detect
        run: |
          # ë¸Œëœì¹˜ëª…ìœ¼ë¡œ ì„¸ì…˜ íƒ€ì… ê°ì§€
          if [[ "${{ github.ref }}" == *"cursor"* ]]; then
            echo "session_type=cursor" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"claude"* ]]; then
            echo "session_type=claude" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"collab"* ]]; then
            echo "session_type=collaborative" >> $GITHUB_OUTPUT
          else
            echo "session_type=unknown" >> $GITHUB_OUTPUT
          fi

          # ë³€ê²½ì‚¬í•­ ë¶„ì„
          CURSOR_CHANGES=$(git log --oneline -1 | grep -c 'cursor\|ui\|frontend' || echo 0)
          CLAUDE_CHANGES=$(git log --oneline -1 | grep -c 'claude\|api\|backend' || echo 0)
          echo "cursor_changes=${CURSOR_CHANGES}" >> $GITHUB_OUTPUT
          echo "claude_changes=${CLAUDE_CHANGES}" >> $GITHUB_OUTPUT

          # ê¸°ëŠ¥ ì™„ì„± ì²´í¬ (ì»¤ë°‹ ë©”ì‹œì§€ì— ì™„ì„± í‚¤ì›Œë“œê°€ ìˆëŠ”ì§€ í™•ì¸)
          COMPLETION_CHECK=$(git log --oneline -1 | grep -E -c 'complete|ì™„ë£Œ|ì™„ì„±|done|finish|feat:' || echo 0)

          if [ $COMPLETION_CHECK -gt 0 ]; then
            echo "sync_required=true" >> $GITHUB_OUTPUT
            echo "feature_complete=true" >> $GITHUB_OUTPUT
          else
            echo "sync_required=false" >> $GITHUB_OUTPUT
            echo "feature_complete=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ“Š Session summary
        run: |
          echo "ğŸµ Vibecoding Session Detected:"
          echo "  - Session Type: ${{ steps.detect.outputs.session_type }}"
          echo "  - Cursor Changes: ${{ steps.detect.outputs.cursor_changes }}"
          echo "  - Claude Changes: ${{ steps.detect.outputs.claude_changes }}"
          echo "  - Feature Complete: ${{ steps.detect.outputs.feature_complete }}"
          echo "  - Sync Required: ${{ steps.detect.outputs.sync_required }}"

      # ğŸ¤– ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ê¶Œí•œ ì„¤ì •
      - name: ğŸ”§ Setup automation scripts
        run: |
          chmod +x scripts/*.sh
          echo "âœ… ìë™í™” ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ì„¤ì • ì™„ë£Œ"

  # ===================================
  # ğŸš€ ë¹ ë¥¸ í’ˆì§ˆ ê²€ì‚¬ (ë°”ì´ë¸Œì½”ë”© ìµœì í™”)
  # ===================================
  quick-check:
    name: ğŸš€ Quick Quality Check
    runs-on: ubuntu-latest
    needs: detect-session
    if: |
      github.event_name == 'push' && 
      (startsWith(github.ref, 'refs/heads/feature/cursor-') ||
       startsWith(github.ref, 'refs/heads/feature/claude-') ||
       startsWith(github.ref, 'refs/heads/feature/collab-'))

    steps:
      - uses: actions/checkout@v4

      # Node.js ë¹ ë¥¸ ì„¤ì •
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“¦ Install dependencies (cached)
        run: pnpm install --frozen-lockfile --prefer-offline

      # Python ë¹ ë¥¸ ì„¤ì • (ë°±ì—”ë“œ ë³€ê²½ì‚¬í•­ ìˆì„ ë•Œë§Œ)
      - uses: actions/setup-python@v4
        if: needs.detect-session.outputs.claude_changes > 0
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ Quick Python setup
        if: needs.detect-session.outputs.claude_changes > 0
        run: |
          pip install ruff black isort
          pip install -r api/requirements.txt --quiet

      # ë¹ ë¥¸ ë¦°íŠ¸ (ë³€ê²½ëœ íŒŒì¼ë§Œ)
      - name: ğŸ” Quick lint (changed files only)
        run: |
          # ë³€ê²½ëœ íŒŒì¼ë“¤ë§Œ ë¦°íŠ¸
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files: $CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q "\.py$"; then
            echo "ğŸ Python files changed - running quick lint"
            ruff check $(echo "$CHANGED_FILES" | grep "\.py$" | xargs) || true
          fi

          if echo "$CHANGED_FILES" | grep -q "\.dart$"; then
            echo "ğŸ“± Flutter files changed - running quick analysis"
            cd client && flutter analyze --no-fatal-infos || true
          fi

      # ì»´íŒŒì¼ ì²´í¬ (ë¹Œë“œê¹Œì§€ëŠ” í•˜ì§€ ì•ŠìŒ)
      - name: ğŸ”§ Quick compile check
        run: |
          if [ "${{ needs.detect-session.outputs.claude_changes }}" -gt 0 ]; then
            echo "ğŸ Checking Python syntax"
            python -m py_compile api/app/*.py || true
          fi

          if [ "${{ needs.detect-session.outputs.cursor_changes }}" -gt 0 ]; then
            echo "ğŸ“± Checking Flutter compilation"
            cd client && flutter analyze --no-fatal-infos || true
          fi

  # ===================================
  # ğŸ¯ ê¸°ëŠ¥ ì™„ì„±ë„ ê²€ì¦
  # ===================================
  feature-validation:
    name: ğŸ¯ Feature Completion Validation
    runs-on: ubuntu-latest
    needs: [detect-session, quick-check]
    if: |
      github.event_name == 'push' && 
      needs.quick-check.result == 'success'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” Check feature completeness
        id: feature-check
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          FEATURE_NAME=$(echo "$BRANCH_NAME" | cut -d'-' -f3-)

          echo "feature_name=$FEATURE_NAME" >> $GITHUB_OUTPUT

          # ê¸°ëŠ¥ ì™„ì„±ë„ ì²´í¬ (ì»¤ë°‹ ë©”ì‹œì§€ ë¶„ì„)
          RECENT_COMMITS=$(git log --oneline -10 --grep="complete\|done\|finish\|ready" | wc -l)

          if [ "$RECENT_COMMITS" -gt 0 ]; then
            echo "completion_status=ready-for-review" >> $GITHUB_OUTPUT
          else
            echo "completion_status=in-progress" >> $GITHUB_OUTPUT
          fi

          # í…ŒìŠ¤íŠ¸ íŒŒì¼ ì¡´ì¬ í™•ì¸
          if find . -name "*test*" -o -name "*spec*" | grep -q "$FEATURE_NAME"; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: ğŸ¯ Feature completion summary
        run: |
          echo "## ğŸ¯ ê¸°ëŠ¥ ì™„ì„±ë„ ì²´í¬" >> $GITHUB_STEP_SUMMARY
          echo "- **ê¸°ëŠ¥ëª…**: ${{ steps.feature-check.outputs.feature_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ì™„ì„± ìƒíƒœ**: ${{ steps.feature-check.outputs.completion_status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **í…ŒìŠ¤íŠ¸ ì¡´ì¬**: ${{ steps.feature-check.outputs.has_tests }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.feature-check.outputs.completion_status }}" = "ready-for-review" ]; then
            echo "âœ… **ê¸°ëŠ¥ì´ ì™„ì„±ë˜ì—ˆìŠµë‹ˆë‹¤! developìœ¼ë¡œ PRì„ ìƒì„±í•˜ì„¸ìš”.**" >> $GITHUB_STEP_SUMMARY
          else
            echo "ğŸš§ **ê¸°ëŠ¥ ê°œë°œì´ ì§„í–‰ì¤‘ì…ë‹ˆë‹¤. ì™„ì„± í›„ 'complete' í‚¤ì›Œë“œë¡œ ì»¤ë°‹í•˜ì„¸ìš”.**" >> $GITHUB_STEP_SUMMARY
          fi

  # ===================================
  # ğŸš€ ìë™ PR ìƒì„± (ê¸°ëŠ¥ ì™„ì„± ì‹œ)
  # ===================================
  auto-pr-to-develop:
    name: ğŸš€ Auto PR to Develop
    runs-on: ubuntu-latest
    needs: [detect-session, quick-check, feature-validation]
    if: |
      needs.feature-validation.outputs.completion_status == 'ready-for-review' &&
      github.event_name == 'push'

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: ğŸš€ Create feature-complete PR to develop
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BRANCH_NAME="${{ github.ref_name }}"
          FEATURE_NAME="${{ needs.feature-validation.outputs.feature_name }}"
          PR_TITLE="âœ¨ [ë°”ì´ë¸Œì½”ë”©] $FEATURE_NAME ê¸°ëŠ¥ ì™„ì„±"

          PR_BODY="# âœ¨ ë°”ì´ë¸Œì½”ë”© ê¸°ëŠ¥ ì™„ì„±

          ## ğŸ¯ ì™„ì„±ëœ ê¸°ëŠ¥
          **ê¸°ëŠ¥ëª…**: $FEATURE_NAME
          **ì„¸ì…˜ íƒ€ì…**: ${{ needs.detect-session.outputs.session_type }}
          **ë¸Œëœì¹˜**: \`$BRANCH_NAME\`

          ## âœ… ì™„ì„± í™•ì¸ì‚¬í•­
          - [x] ê¸°ëŠ¥ êµ¬í˜„ ì™„ë£Œ
          - [${{ needs.feature-validation.outputs.has_tests == 'true' && 'x' || ' ' }}] í…ŒìŠ¤íŠ¸ ì‘ì„±
          - [x] í’ˆì§ˆ ê²€ì‚¬ í†µê³¼
          - [ ] ì½”ë“œ ë¦¬ë·° ëŒ€ê¸°

          ## ğŸ”„ ë‹¤ìŒ ë‹¨ê³„
          1. ì½”ë“œ ë¦¬ë·° ì™„ë£Œ í›„ developì— ë¨¸ì§€
          2. develop â†’ main PR ê³ ë ¤
          3. ë°°í¬ ì¤€ë¹„

          > ğŸµ Cursorì™€ Claude Codeì˜ ë°”ì´ë¸Œì½”ë”©ìœ¼ë¡œ ì™„ì„±ëœ ê¸°ëŠ¥ì…ë‹ˆë‹¤!"

          # develop ë¸Œëœì¹˜ í™•ì¸/ìƒì„±
          git fetch origin || true
          git checkout -B develop origin/main 2>/dev/null || git checkout develop

          # PR ìƒì„± (ì¤‘ë³µ ë°©ì§€)
          if ! gh pr list --head "$BRANCH_NAME" --base develop --state open | grep -q "$BRANCH_NAME"; then
            gh pr create \
              --title "$PR_TITLE" \
              --body "$PR_BODY" \
              --base develop \
              --head "$BRANCH_NAME" \
              --label "vibecoding,feature-complete,ready-for-review"
            echo "âœ… PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "â„¹ï¸ PRì´ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤."
          fi

  # ===================================
  # ğŸµ ë°”ì´ë¸Œì½”ë”© ì„¸ì…˜ ìƒíƒœ ë¦¬í¬íŠ¸
  # ===================================
  session-report:
    name: ğŸµ Vibecoding Session Report
    runs-on: ubuntu-latest
    needs: [detect-session, quick-check]
    if: always()

    steps:
      - name: ğŸ“Š Generate session report
        run: |
          echo "# ğŸµ Vibecoding Session Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ì„¸ì…˜ ì •ë³´" >> $GITHUB_STEP_SUMMARY
          echo "- **ì„¸ì…˜ íƒ€ì…**: ${{ needs.detect-session.outputs.session_type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ë°‹ í•´ì‹œ**: \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ë³€ê²½ì‚¬í•­ ë¶„ì„" >> $GITHUB_STEP_SUMMARY
          echo "- **ì»¤ì„œ ê´€ë ¨ ë³€ê²½**: ${{ needs.detect-session.outputs.cursor_changes }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **í´ë¡œë“œ ê´€ë ¨ ë³€ê²½**: ${{ needs.detect-session.outputs.claude_changes }}ê°œ" >> $GITHUB_STEP_SUMMARY
          echo "- **ë™ê¸°í™” í•„ìš”**: ${{ needs.detect-session.outputs.sync_required }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- **ë¹ ë¥¸ ê²€ì‚¬**: ${{ needs.quick-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ğŸš€ **ë‹¤ìŒ ë‹¨ê³„**: ê¸°ëŠ¥ ì™„ë£Œ ì»¤ë°‹ ì‹œ ìë™ìœ¼ë¡œ develop ë¸Œëœì¹˜ë¡œ PRì´ ìƒì„±ë©ë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY

  # ===================================
  # ğŸ”” Discord/Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  # ===================================
  notify-session:
    name: ğŸ”” Session Notification
    runs-on: ubuntu-latest
    needs: [detect-session, quick-check]
    if: |
      always() && 
      (needs.quick-check.result == 'failure' || 
       needs.detect-session.outputs.sync_required == 'true')

    steps:
      - name: ğŸ”” Send notification
        run: |
          # Discord/Slack ì›¹í›… URLì´ ì„¤ì •ë˜ì–´ ìˆìœ¼ë©´ ì•Œë¦¼ ë°œì†¡
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            WEBHOOK_DATA=$(cat <<EOF
          {
            "embeds": [{
              "title": "ğŸµ Vibecoding Session Update",
              "description": "ì„¸ì…˜ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.",
              "color": 3447003,
              "fields": [
                {"name": "ë¸Œëœì¹˜", "value": "${{ github.ref_name }}", "inline": true},
                {"name": "ì„¸ì…˜ íƒ€ì…", "value": "${{ needs.detect-session.outputs.session_type }}", "inline": true},
                {"name": "í’ˆì§ˆ ê²€ì‚¬", "value": "${{ needs.quick-check.result }}", "inline": true}
              ]
            }]
          }
          EOF
          )
            curl -H "Content-Type: application/json" \
                 -d "$WEBHOOK_DATA" \
                 "${{ secrets.DISCORD_WEBHOOK_URL }}" || echo "Notification failed"
          fi
