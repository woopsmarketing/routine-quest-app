name: ğŸš€ Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'
  FLUTTER_VERSION: '3.16.0'

jobs:
  # ===================================
  # ğŸ·ï¸ ë¦´ë¦¬ìŠ¤ ì¤€ë¹„ ë° ë²„ì „ ê´€ë¦¬
  # ===================================
  release:
    name: ğŸ·ï¸ Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4
        with:
          # ì „ì²´ Git íˆìŠ¤í† ë¦¬ê°€ í•„ìš” (changesetì„ ìœ„í•´)
          fetch-depth: 0
          # Personal Access Token í•„ìš” (protected branchì— pushí•˜ê¸° ìœ„í•´)
          token: ${{ secrets.GITHUB_TOKEN }}

      # Node.js ì„¤ì •
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: ğŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile

      # Python ì„¤ì • (ë°±ì—”ë“œ ë²„ì „ ê´€ë¦¬ìš©)
      - uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # Flutter ì„¤ì • (í´ë¼ì´ì–¸íŠ¸ ë²„ì „ ê´€ë¦¬ìš©)
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      # Git ì„¤ì •
      - name: ğŸ”§ Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # Changeset ìƒíƒœ í™•ì¸
      - name: ğŸ“‹ Check for changesets
        id: changeset-status
        run: |
          if pnpm changeset status --output=json | jq -e '.changesets | length > 0'; then
            echo "has-changesets=true" >> $GITHUB_OUTPUT
          else
            echo "has-changesets=false" >> $GITHUB_OUTPUT
          fi

      # ë²„ì „ ì—…ë°ì´íŠ¸ ë° ë¦´ë¦¬ìŠ¤
      - name: ğŸ·ï¸ Version and release
        if: steps.changeset-status.outputs.has-changesets == 'true'
        run: |
          # ë²„ì „ ì—…ë°ì´íŠ¸
          pnpm changeset version

          # ë¹Œë“œ (ë¦´ë¦¬ìŠ¤ ì „ ìµœì¢… í™•ì¸)
          pnpm turbo build --filter=!@routine-quest/docs

          # ë³€ê²½ì‚¬í•­ ì»¤ë°‹
          git add .
          git commit -m "chore: release packages" || echo "No changes to commit"

          # GitHub Release ìƒì„± ë° íƒœê·¸
          pnpm changeset publish

          # ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
          git push origin main --follow-tags
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
      - name: ğŸ“ Generate release notes
        if: steps.changeset-status.outputs.has-changesets == 'true'
        run: |
          # ìµœì‹  íƒœê·¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")

          # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
          echo "## ğŸ‰ Release Notes" > release-notes.md
          echo "" >> release-notes.md
          echo "### Changes since $LATEST_TAG" >> release-notes.md
          echo "" >> release-notes.md

          # Changesetì—ì„œ ë³€ê²½ì‚¬í•­ ì¶”ì¶œ
          if [ -f "CHANGELOG.md" ]; then
            head -50 CHANGELOG.md >> release-notes.md
          fi

      # ë°°í¬ íŠ¸ë¦¬ê±° (í•„ìš”ì‹œ)
      - name: ğŸš€ Trigger deployment
        if: steps.changeset-status.outputs.has-changesets == 'true'
        run: |
          echo "ğŸš€ ë¦´ë¦¬ìŠ¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "ë°°í¬ëŠ” ë³„ë„ì˜ ì›Œí¬í”Œë¡œìš°ì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤."

          # ë°°í¬ ì›Œí¬í”Œë¡œìš° íŠ¸ë¦¬ê±° (ì„ íƒì )
          # gh workflow run deploy.yml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ===================================
  # ğŸ“Š ë¦´ë¦¬ìŠ¤ í›„ ì‘ì—…
  # ===================================
  post-release:
    name: ğŸ“Š Post Release
    runs-on: ubuntu-latest
    needs: release
    if: always() && needs.release.result == 'success'

    steps:
      - uses: actions/checkout@v4

      # ë¦´ë¦¬ìŠ¤ ì„±ê³µ ì•Œë¦¼ (ì„ íƒì )
      - name: ğŸ“¢ Release notification
        run: |
          echo "ğŸ“¢ ìƒˆë¡œìš´ ë¦´ë¦¬ìŠ¤ê°€ ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
          # ìŠ¬ë™, ë””ìŠ¤ì½”ë“œ ë“± ì•Œë¦¼ ì„¤ì • ê°€ëŠ¥

          # í˜„ì¬ ë²„ì „ í™•ì¸
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "ğŸ·ï¸ Version: $CURRENT_VERSION"

          # ë¦´ë¦¬ìŠ¤ í†µê³„
          echo "ğŸ“Š ë¦´ë¦¬ìŠ¤ í†µê³„:"
          echo "  â€¢ ì»¤ë°‹ ìˆ˜: $(git rev-list --count HEAD)"
          echo "  â€¢ ê¸°ì—¬ì ìˆ˜: $(git shortlog -sn | wc -l)"

      # ë‹¤ìŒ ê°œë°œ ì‚¬ì´í´ ì¤€ë¹„ (ì„ íƒì )
      - name: ğŸ”„ Prepare next development cycle
        run: |
          echo "ğŸ”„ ë‹¤ìŒ ê°œë°œ ì‚¬ì´í´ì„ ì¤€ë¹„í•©ë‹ˆë‹¤..."

          # ê°œë°œ ë¸Œëœì¹˜ ì •ë¦¬, ì´ìŠˆ ì •ë¦¬ ë“±
          # í•„ìš”ì— ë”°ë¼ ìë™í™” ì‘ì—… ì¶”ê°€
